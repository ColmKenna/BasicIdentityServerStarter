@page "{clientId}"
@using System.Linq.Expressions
@using IdentityDataModels
@using IdentityServerAspNetIdentity.Pages.Admin.Clients
@using IdentityServerAspNetIdentity.Pages.Components.HtmlModal
@using IdentityServerAspNetIdentity.TagHelpers.Fields
@using IdentityServerAspNetIdentity.TagHelpers.FormRow
@using IdentityServerAspNetIdentity.TagHelpers.Tabs
@using Microsoft.AspNetCore.Mvc.ModelBinding
@using Microsoft.AspNetCore.Mvc.TagHelpers
@inject Microsoft.AspNetCore.Mvc.ModelBinding.IModelMetadataProvider MetadataProvider
@model IdentityServerAspNetIdentity.Pages.Admin.Clients.Edit

<h1>Edit @Model.Client.ClientId</h1>
<form method="post">
    <tab id="clientDetails">
        <tab-item header="Client Information">
            <input type="hidden" asp-for="@Model.Client.ClientId"/>
            <form-row for="@Model.Client.ClientName"></form-row>
            <form-row for="@Model.Client.Description"></form-row>
            <form-row for="@Model.Client.ClientUri"></form-row>
        </tab-item>
        <tab-item header="Security">

            <div id="secretsHolder">
                @for (int i = 0; i < Model.Client.ClientSecrets.Count; i++)
                {
                <form-row for="@Model.Client.ClientSecrets[i].Description"></form-row>
                <form-row for="@Model.Client.ClientSecrets[i].Secret" hidden="true"></form-row>
                }



                <form-row-container>
                <button type="button" class="success-button btn-small" data-ck-modal-target="addClientSecretModal">Add Secret
                </button>
                </form-row-container>

                <template id="clientSecretTemplate">
                    <form-row-template for="@Model.Client.ClientSecrets.FirstOrDefault().Description" root="@Model.Client.Description"></form-row-template>
                    <form-row-template for="@Model.Client.ClientSecrets.FirstOrDefault().Secret" root="@Model.Client.ClientSecrets" hidden="true"></form-row-template>
                </template>


            </div>
            <form-row  label="Require Consent" for="@Model.Client.RequireConsent"></form-row>
            <form-row  label="AllowAccessTokens Via Browser" for="@Model.Client.AllowAccessTokensViaBrowser"></form-row>
            <form-row  label="AccessToken Lifetime" for="@Model.Client.AccessTokenLifetime"></form-row>

            <form-row-container label="grant Types">

                <div id="selection-container" class="check-selection-container check-group-container  with-divider with-bottom-divider ">
                
                @foreach (var grantType in Model.Client.AvailableGrantTypes)
                    {
                        // create a checkbox for each grant type
                        <selection-item name="Client.AllowedGrantTypes[]" value="@grantType"  checked="@Model.Client.AllowedGrantTypes.Contains(grantType)"></selection-item>
                    }
                </div>
            </form-row-container>


        </tab-item>
        <tab-item header="Scopes">
            @for (var i = 0; i < Model.Client.AllowedScopes.Count; i++)
            {
                <input asp-for="@Model.Client.AllowedScopes[i]"/>
            }
            <template id="scopeTemplate">
                <input type="text" id="scope" name="scope" value="">
            </template>
            <button id="addScope">Add Scope</button>

        </tab-item>
        <tab-item header="URIs">
            <field-container label="Redirect URIs" value="@string.Join(", ", Model.Client.RedirectUris)"/>
            <field-container label="Post Logout Redirect URIs"
                             value="@string.Join(", ", Model.Client.PostLogoutRedirectUris)"/>
            <field-container label="Allowed CORS Origins" value="@string.Join(", ", Model.Client.AllowedCorsOrigins)"/>
        </tab-item>


    </tab>

</form>




<script>
    // addNewSecret
    function addNewSecret() {
        var secret = document.getElementById("newSecretInput").value;
        var secretConfirm = document.getElementById("newSecretInputConfirm").value;
        var description = document.getElementById("newSecretDescriptionInput").value;

        if (secret !== secretConfirm) {
            alert("Secrets do not match");
            return;
        }
        // get the index of the new secret amount of field-containers with name starting with Client.ClientSecrets[ and ending with ].Description
        var secrets = document.querySelectorAll('input[name^="Client.ClientSecrets["][name$="].Secret"]');
        
        var index = secrets.length;
        var newSeceret = cloneClientSecretTemplate(index, description, secret);
        // if secretsHolder has a button add new node before it
        
        var selectionContainer = document.getElementById("secretsHolder");
        var button = selectionContainer.querySelector('button');
        if (button) {
            selectionContainer.insertBefore(newSeceret,button);
        } else {
            selectionContainer.appendChild(newSeceret);
        }

    }
    function cloneClientSecretTemplate(index, descriptionValue, secretValue) {
        // Access the template
        const template = document.getElementById('clientSecretTemplate');

        // Get the template content as a string
        let templateHTML = template.innerHTML;

        // Replace the placeholder {{index}} with the provided index
        templateHTML = templateHTML.replace(/replace_with_index/g, index);

        // Create a temporary container to parse the template into DOM elements
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = templateHTML;

        // Select the parsed template content
        const clonedElement = tempDiv.firstElementChild;

        // Set the value for the description input
        const descriptionInput = clonedElement.querySelector(`input[name="Client.ClientSecrets[${index}].Description"]`);
        if (descriptionInput) {
            descriptionInput.value = descriptionValue || ''; // Default to an empty string if no value is provided
        }

        // Set the value for the secret input
        const secretInput = clonedElement.querySelector(`input[name="Client.ClientSecrets[${index}].Secret"]`);
        if (secretInput) {
            secretInput.value = secretValue || ''; // Default to an empty string if no value is provided
        }

        return clonedElement;
    }
</script>
@{
    var newClientSecretsViewModal = new ModalViewModel(
        "addClientSecretModal",
        "Add Client Secret",
        "Enter the following information:",
        "Add Secret",
        "Close",
        "addNewSecret()",
        new ModalInputs("newSecretInput", "Secret", "password"),
        new ModalInputs("newSecretInputConfirm", "Confirm Secret", "password"),
        new ModalInputs("newSecretDescriptionInput", "Description", "text")
    );
}
<vc:html-modal model="newClientSecretsViewModal"/>